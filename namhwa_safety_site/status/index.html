<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚¨í™”í† ê±´ ì•ˆì „ë³´ê±´ í†µí•© ë¡œë“œë§µ (Admin Ver)</title>
    <style>
        /* [ê³µí†µ] í°íŠ¸ ë° ê¸°ë³¸ ì„¤ì • */
        :root {
            --primary: #4a90e2;   /* íŒŒë‘ */
            --danger: #d9534f;    /* ë¹¨ê°• */
            --warning: #f0ad4e;   /* ë…¸ë‘ */
            --orange: #e67e22;    /* ì£¼í™© */
            --success: #5cb85c;   /* ì´ˆë¡ */
            --navy: #2c3e50;      /* ë‚¨ìƒ‰ (í—¤ë”) */
            --dark: #343a40;      /* ë‹¤í¬ (ì¤€ê³µ) */
            --purple: #9b59b6;    /* ë³´ë¼ */
            --border: #e0e0e0;
        }
        body { font-family: 'Pretendard', 'Malgun Gothic', sans-serif; margin: 0; background: #f4f6f9; color: #333; padding-bottom: 50px; }
        
        /* [ë©”ì¸] ìƒë‹¨ í”„ë¡œì íŠ¸ ì •ë³´ */
        .header-panel { background: #fff; padding: 20px; border-bottom: 1px solid var(--border); margin-bottom: 20px; }
        .info-container { display: flex; gap: 15px; max-width: 1400px; margin: 0 auto; }
        .info-box { flex: 1; background: #f0f4ff; border: 1px solid #d0dbf5; padding: 15px; border-radius: 5px; font-size: 14px; display: flex; flex-direction: column; gap: 5px; }
        .info-box.pink { background: #fff0f0; border-color: #ffd0d0; }
        .info-title { font-weight: bold; color: #555; font-size: 12px; }
        
        /* ìƒë‹¨ í¸ì§‘ ê°€ëŠ¥ í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .info-content { outline: none; padding: 2px 5px; border-radius: 4px; transition: background 0.2s; border: 1px solid transparent; }
        .info-content:hover { background: rgba(0,0,0,0.05); cursor: text; }
        .info-content:focus { background: #fff; border-color: var(--primary); box-shadow: 0 0 3px rgba(74, 144, 226, 0.3); }

        /* [ë©”ì¸] ì°¨íŠ¸ ê·¸ë¦¬ë“œ */
        .chart-wrapper { max-width: 1400px; margin: 0 auto 30px auto; background: #fff; border: 1px solid var(--border); border-radius: 8px; overflow-x: auto; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .grid-container { display: grid; grid-template-columns: 200px repeat(10, 1fr); min-width: 1200px; }
        .cell { border-right: 1px solid var(--border); border-bottom: 1px solid var(--border); padding: 10px; font-size: 13px; position: relative; }
        .cell-header { background: #f5f5f5; text-align: center; font-weight: bold; padding: 12px; }
        .cell-sidebar { background: #fff; font-weight: bold; color: #0056b3; display: flex; align-items: center; padding-left: 20px; }
        .cell-sidebar.safety-row { background: #fffdf0; color: #333; font-size: 12px; }
        .clickable-cell { cursor: pointer; transition: background 0.2s; }
        .clickable-cell:hover { background-color: #f0f8ff; }

        /* [ë©”ì¸] ê³µì • ë§‰ëŒ€ */
        .task-bar { height: 30px; border-radius: 4px; color: white; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: transform 0.2s; margin-top: 5px; }
        .task-bar:hover { transform: scale(1.02); z-index: 10; }
        
        .bg-blue { background: var(--primary); }
        .bg-red { background: var(--danger); }
        .bg-yellow { background: var(--warning); color: #fff; text-shadow: 0 0 2px rgba(0,0,0,0.5); }
        .bg-green { background: var(--success); }
        .bg-grey { background: #6c757d; }
        .bg-warning { background: var(--orange); color: white; }
        .bg-dark { background: var(--dark); color: white; }

        .divider-row { grid-column: 1 / -1; background: #eef2f5; text-align: center; font-weight: bold; padding: 8px; font-size: 13px; color: #555; border-bottom: 1px solid var(--border); }
        
        /* íƒœê·¸ ìŠ¤íƒ€ì¼ */
        .tag-container { display: flex; flex-direction: column; gap: 4px; align-items: center; min-height: 40px; justify-content: center; }
        .tag { font-size: 11px; padding: 3px 6px; border-radius: 6px; border: 1px solid #ddd; background: #fff; text-align: center; width: 95%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: bold; }
        
        .tag.pink { background: #ffeef0; color: #d63384; border-color: #f8d7da; }
        .tag.green { background: #e8f5e9; color: #2e7d32; border-color: #c8e6c9; }
        .tag.orange { background: #fff3e0; color: #e65100; border-color: #ffe0b2; }
        .tag.blue { background: #e3f2fd; color: #1565c0; border-color: #bbdefb; }
        .tag.red { background: #fff5f5; color: #dc3545; border-color: #ffc9c9; }
        .tag.purple { background: #f3e5f5; color: #7b1fa2; border-color: #e1bee7; }

        /* KPI í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .kpi-section { max-width: 1400px; margin: 0 auto; background: #fff; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .kpi-header-title { background: #2c3e50; color: white; padding: 15px 20px; font-size: 16px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .kpi-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .kpi-th { background: #f8f9fa; color: #333; font-weight: bold; padding: 12px; border: 1px solid #ddd; text-align: center; background: #eef2f5; }
        .kpi-td { border: 1px solid #ddd; padding: 12px; vertical-align: middle; line-height: 1.6; }
        .kpi-td.center { text-align: center; }
        
        .text-red { color: #d9534f; font-weight: bold; }
        .text-blue { color: #4a90e2; font-weight: bold; }
        .editable { outline: none; transition: background 0.2s; border-radius: 4px; padding: 5px; }
        .editable:hover { background: #f8f9fa; cursor: pointer; }
        .editable:focus { background: #fff; border: 1px solid var(--primary); cursor: text; box-shadow: 0 0 5px rgba(74, 144, 226, 0.3); }

        /* íŒì—… UI */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-box { background: white; width: 650px; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.3); overflow: hidden; display: flex; flex-direction: column; }
        .modal-header { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 18px; font-weight: bold; color: #333; margin: 0; }
        .btn-close { background: none; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; cursor: pointer; padding: 2px 8px; color: #555; }
        .modal-body { padding: 20px; display: flex; flex-direction: column; gap: 20px; max-height: 80vh; overflow-y: auto; }
        .form-label { font-size: 13px; font-weight: bold; color: #666; margin-bottom: 8px; display: block; }
        .form-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box; }
        .row-2-col { display: flex; gap: 20px; }
        .col { flex: 1; }
        .risk-text { color: var(--danger); font-weight: bold; }
        .comment-section { background-color: #f1f3f5; padding: 15px; border-radius: 8px; }
        .comment-list { list-style: none; padding: 0; margin: 0 0 10px 0; max-height: 150px; overflow-y: auto; }
        .comment-item { font-size: 13px; color: #333; padding: 8px 0; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; }
        .comment-item strong { color: var(--navy); }
        .comment-date { color: #888; font-size: 11px; margin-left: 5px; }
        
        /* ëŒ“ê¸€ ì‚­ì œ ë²„íŠ¼ */
        .btn-del-comment { background: none; border: none; color: #999; cursor: pointer; font-size: 12px; margin-left: 10px; }
        .btn-del-comment:hover { color: #d9534f; font-weight: bold; }

        .comment-input-group { display: flex; gap: 8px; }
        .input-name { width: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; text-align: center; }
        .input-content { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; }
        .modal-footer { padding: 15px 20px; border-top: 1px solid #eee; background: #fff; text-align: right; display: flex; justify-content: flex-end; gap: 8px; }
        .btn { padding: 8px 20px; border-radius: 4px; font-size: 14px; font-weight: bold; cursor: pointer; border: none; }
        .btn-gray { background: #e0e0e0; color: #333; }
        .btn-navy { background: var(--navy); color: white; }
        
        .preview-box { margin-top: 10px; padding: 10px; border: 1px dashed #ccc; border-radius: 5px; text-align: center; background: #fafafa; display: none; position: relative; }
        .preview-img { max-width: 100%; max-height: 200px; border-radius: 5px; }
        .btn-delete-img { position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.6); color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; }

        .tag-editor-list { display: flex; flex-wrap: wrap; gap: 8px; padding: 10px; background: #f8f9fa; border-radius: 5px; min-height: 50px; border: 1px solid #eee; margin-bottom: 10px; }
        .tag-item { display: flex; align-items: center; font-size: 12px; padding: 4px 8px; border-radius: 15px; border: 1px solid #ddd; font-weight: bold; }
        .tag-item .del-btn { margin-left: 6px; cursor: pointer; color: #888; font-weight: bold; }
        .tag-input-group { display: flex; gap: 5px; }
        .color-select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>

    <div class="header-panel">
        <h2 style="text-align:center; margin-bottom: 20px;">ëŒ€ê´‘ ìƒˆë§ˆì„ê¸ˆê³  ê³¨í”„ì—°ìŠµì¥ ì‹ ì¶•ê³µì‚¬</h2>
        <div class="info-container">
            <div class="info-box">
                <div class="info-title">ğŸ“… ê³µì‚¬ ê¸°ê°„</div>
                <div id="infoPeriod" class="info-content" contenteditable="true" onblur="saveHeaderInfo()">
                    ì‹¤ì°©ê³µì¼ë¡œë¶€í„° 10ê°œì›” (2025.01 ~ 2025.10)
                </div>
            </div>
            <div class="info-box">
                <div class="info-title">ğŸ¢ ê³µì‚¬ ê·œëª¨</div>
                <div id="infoScale" class="info-content" contenteditable="true" onblur="saveHeaderInfo()">
                    ì§€í•˜1ì¸µ ~ ì§€ìƒ4ì¸µ / 49íƒ€ì„ (ì² ê³¨+RCì¡°)
                </div>
            </div>
            <div class="info-box pink">
                <div class="info-title">ğŸ† ì•ˆì „ ëª©í‘œ</div>
                <div id="infoGoal" class="info-content" contenteditable="true" onblur="saveHeaderInfo()" style="color:#d9534f; font-weight:bold;">
                    ì¤‘ëŒ€ì¬í•´ ZERO / ë¬´ì¬í•´ 300ì¼ ë‹¬ì„±
                </div>
            </div>
        </div>
    </div>

    <div class="chart-wrapper">
        <div class="grid-container" id="mainGrid"></div>
    </div>

    <div class="kpi-section">
        <div class="kpi-header-title">
            <span>ğŸ“‹ ì›”ë³„ ì•ˆì „ë³´ê±´ ì¤‘ì  í™œë™ ë° ì„±ê³¼ ëª©í‘œ (KPI)</span>
            <span style="font-size:12px; font-weight:normal; opacity:0.8;">â€» í‘œì˜ ë‚´ìš©ì„ í´ë¦­í•˜ì—¬ ì§ì ‘ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ìë™ ì €ì¥)</span>
        </div>
        <table class="kpi-table">
            <colgroup>
                <col style="width: 50px;">
                <col style="width: 150px;">
                <col style="width: 150px;">
                <col style="width: auto;">
                <col style="width: 120px;">
                <col style="width: 120px;">
            </colgroup>
            <thead>
                <tr>
                    <th class="kpi-th">ì›”</th>
                    <th class="kpi-th">ì£¼ìš” ê³µì •</th>
                    <th class="kpi-th">í•µì‹¬ ìœ„í—˜ (Risk)</th>
                    <th class="kpi-th">ì•ˆì „ë³´ê±´ í™œë™ (P-D-C-A)</th>
                    <th class="kpi-th">ì„±ê³¼ ì§€í‘œ (KPI)</th>
                    <th class="kpi-th">ë²•ì  ì„œë¥˜</th>
                </tr>
            </thead>
            <tbody id="kpiTableBody"></tbody>
        </table>
    </div>

    <div id="modal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">ê³µì • ìƒì„¸ í™œë™</h3>
                <button class="btn-close" onclick="closeModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="row-2-col">
                    <div class="col">
                        <label class="form-label">âš ï¸ í•µì‹¬ ìœ„í—˜ (Risk) - <span>ìˆ˜ì • ê°€ëŠ¥</span></label>
                        <input type="text" id="modalRisk" class="form-input risk-text">
                    </div>
                    <div class="col">
                        <label class="form-label">ğŸ“ˆ ì„±ê³¼ ì§€í‘œ (KPI) - <span>ìˆ˜ì • ê°€ëŠ¥</span></label>
                        <input type="text" id="modalKPI" class="form-input">
                    </div>
                </div>
                <div>
                    <label class="form-label">ğŸ“ ê¸ˆì¼ ì•ˆì „ë³´ê±´ í™œë™ ê¸°ë¡</label>
                    <textarea id="modalActivity" class="form-input" rows="4"></textarea>
                </div>
                <div>
                    <label class="form-label">ğŸ“¸ ì‚¬ì§„/ë¬¸ì„œ ì²¨ë¶€</label>
                    <input type="file" id="fileInput" class="form-input" style="padding: 6px;" accept="image/*" onchange="handleFileSelect(this)">
                    <div id="previewBox" class="preview-box">
                        <button class="btn-delete-img" onclick="deleteImage()">Ã—</button>
                        <img id="previewImg" class="preview-img" src="">
                    </div>
                </div>
                <div class="comment-section">
                    <label class="form-label">ğŸ’¬ í˜„ì¥ ì†Œí†µ (ëŒ“ê¸€)</label>
                    <ul class="comment-list" id="commentList"></ul>
                    <div class="comment-input-group">
                        <input type="text" id="writerName" class="input-name" placeholder="ì´ë¦„">
                        <input type="text" id="commentContent" class="input-content" placeholder="ë‚´ìš©...">
                        <button class="btn btn-navy" onclick="addComment()">ë“± ë¡</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-gray" onclick="closeModal()">ë‹«ê¸°</button>
                <button class="btn btn-navy" onclick="saveTaskDetails()">ì €ì¥í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <div id="safetyModal" class="modal-overlay">
        <div class="modal-box" style="width: 450px;">
            <div class="modal-header">
                <h3 class="modal-title" id="safetyModalTitle">ì¼ì • íƒœê·¸ ìˆ˜ì •</h3>
                <button class="btn-close" onclick="closeSafetyModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <p style="font-size:13px; color:#666; margin-bottom:10px;">í•´ë‹¹ ì›”ì˜ í™œë™ íƒœê·¸ë¥¼ ì¶”ê°€í•˜ê±°ë‚˜ ì‚­ì œí•˜ì„¸ìš”.</p>
                <label class="form-label">í˜„ì¬ ë“±ë¡ëœ íƒœê·¸</label>
                <div id="currentTagList" class="tag-editor-list"></div>
                <label class="form-label">ìƒˆ íƒœê·¸ ì¶”ê°€</label>
                <div class="tag-input-group">
                    <select id="newTagColor" class="color-select">
                        <option value="blue">í‰ê°€(íŒŒë‘)</option>
                        <option value="green">êµìœ¡(ì´ˆë¡)</option>
                        <option value="red">íŠ¹ë³„(ë¹¨ê°•)</option>
                        <option value="orange">ì ê²€(ì£¼í™©)</option>
                        <option value="pink">ì¸¡ì •(ë¶„í™)</option>
                        <option value="purple">íšŒì˜(ë³´ë¼)</option>
                    </select>
                    <input type="text" id="newTagText" class="form-input" placeholder="ë‚´ìš© (ì˜ˆ: ì •ê¸°êµìœ¡)">
                    <button class="btn btn-navy" style="padding: 0 15px;" onclick="addSafetyTag()">ì¶”ê°€</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-gray" onclick="closeSafetyModal()">ì·¨ì†Œ</button>
                <button class="btn btn-navy" onclick="saveSafetyChanges()">ì ìš©í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <script>
        // === ë°ì´í„° ë° ë³€ìˆ˜ ===
        const constructionData = [
            { name: "ê°€ì„¤/í† ê³µì‚¬", start: 1, duration: 1, color: "bg-grey", label: "ê°€ì„¤(EGI)/í„°íŒŒê¸°", risk: "ê°€ì„¤ë¬¼ ì „ë„, í˜‘ì°©", kpi: "êµìœ¡ ì´ìˆ˜ìœ¨ 100%" },
            { name: "ê¸°ì´ˆ/ì§€í•˜ê³¨ì¡°", start: 2, duration: 1, color: "bg-blue", label: "ê¸°ì´ˆ/ì§€í•˜", risk: "ê±°í‘¸ì§‘ ë¶•ê´´, ì§ˆì‹", kpi: "ë°€íê³µê°„ í—ˆê°€ 100%" },
            { name: "ì§€ìƒê³¨ì¡°(RC)", start: 3, duration: 3, color: "bg-blue", label: "1F~4F ê³¨ì¡°", risk: "ë‹¨ë¶€ ì¶”ë½, ë¶•ê´´", kpi: "TBM ì°¸ì—¬ìœ¨ 100%" },
            { name: "ì² ê³¨/ì² íƒ‘ê³µì‚¬", start: 3, duration: 2, color: "bg-red", label: "ì² íƒ‘/íƒ€ì„ ë¹”", risk: "í¬ë ˆì¸ ì „ë„, ë‚™í•˜", kpi: "ìœ„í—˜ìš”ì¸ ê°œì„ ìœ¨ 90%" },
            { name: "ë§ˆê°/ì°½í˜¸/ë°©ìˆ˜", start: 6, duration: 2, color: "bg-yellow", label: "ë‚´ì™¸ì¥/ë°©ìˆ˜", risk: "ì¤‘ë…, ë§ë¹„ê³„ ì „ë„", kpi: "ë¶€ì í•© ì‚¬í•­ ì¡°ì¹˜ìœ¨ 100%" },
            { name: "ë¹„ê³„í•´ì²´/ì •ë¦¬", start: 7, duration: 1, color: "bg-warning", label: "ë¹„ê³„í•´ì²´", risk: "í•´ì²´ ì¤‘ ì¶”ë½, ë‚™í•˜", kpi: "ì•„ì°¨ì‚¬ê³  ë°œêµ´ 5ê±´â†‘" },
            { name: "ë¶€ëŒ€í† ëª©/ì¡°ê²½", start: 9, duration: 1, color: "bg-green", label: "í¬ì¥/ì¡°ê²½", risk: "ì¥ë¹„ ì¶©ëŒ, í˜‘ì°©", kpi: "ì¥ë¹„ì ê²€ ì‹¤ì‹œìœ¨ 100%" },
            { name: "ì¤€ê³µ/ì¸ê³„", start: 10, duration: 1, color: "bg-dark", label: "ì¤€ê³µ", risk: "ì „ë„, íê¸°ë¬¼ ì‚¬ê³ ", kpi: "ë¬´ì¬í•´ ë‹¬ì„±" }
        ];

        const defaultSafetyRows = [
            { title: "ìœ„í—˜ì„±í‰ê°€", monthlyTags: { 1: ["ìµœì´ˆí‰ê°€|blue", "TBM|pink"], 2: ["ìˆ˜ì‹œ|blue", "TBM|pink"], 3: ["ìˆ˜ì‹œ|blue", "TBM|pink"], 6: ["ì •ê¸°|blue"] } },
            { title: "ì•ˆì „êµìœ¡", monthlyTags: { 1: ["ì±„ìš©ì‹œ|green"], 2: ["íŠ¹ë³„(ë°€í)|red"], 3: ["íŠ¹ë³„(ì² íƒ‘)|red"], 5: ["ì •ê¸°|green"] } },
            { title: "í˜‘ì˜ì²´/íšŒì˜", monthlyTags: { 1: ["í˜‘ì˜ì²´|purple"], 2: ["í˜‘ì˜ì²´|purple"], 3: ["í˜‘ì˜ì²´|purple"] } },
            { title: "ë²•ì ì ê²€", monthlyTags: { 1: ["í•´ë¹™ê¸°|orange"], 2: ["í•©ë™|orange"], 6: ["ì¥ë§ˆì² |orange"] } },
            { title: "ì„±ê³¼ì¸¡ì •", monthlyTags: { 1: ["ì´í–‰ì ê²€|pink"], 6: ["ê²½ì˜ê²€í† |pink"] } }
        ];

        const defaultKpiData = [
            { month: 1, process: "ê°€ì„¤(EGI), í„°íŒŒê¸°", risk: "ê°€ì„¤ë¬¼ ì „ë„, í˜‘ì°©", activity: "â€¢ [í‰ê°€] ìµœì´ˆ ìœ„í—˜ì„±í‰ê°€ ì‹¤ì‹œ ë° ì „íŒŒ\nâ€¢ [êµìœ¡] ì‹ ê·œì íŠ¹ë³„ì•ˆì „êµìœ¡(ì¥ë¹„)\nâ€¢ [ì ê²€] ì›”ê°„ í•©ë™ ì•ˆì „ì ê²€ (1íšŒì°¨)", kpi: "êµìœ¡ ì´ìˆ˜ìœ¨ 100%", docs: "ìœ í•´ìœ„í—˜\në°©ì§€ê³„íšì„œ" },
            { month: 2, process: "ê¸°ì´ˆ/ì§€í•˜ ê³¨ì¡°", risk: "ê±°í‘¸ì§‘ ë¶•ê´´, ì§ˆì‹", activity: "â€¢ [í‰ê°€] ê³¨ì¡°ê³µì‚¬ ìƒì‹œ ìœ„í—˜ì„±í‰ê°€\nâ€¢ [êµìœ¡] ë°€íê³µê°„ ì‘ì—… íŠ¹ë³„êµìœ¡\nâ€¢ [ì ê²€] í•©ë™ì ê²€: ê°œêµ¬ë¶€ ë®ê°œ í™•ì¸", kpi: "ë°€íê³µê°„\ní—ˆê°€ 100%", docs: "ì½˜í¬ë¦¬íŠ¸\níƒ€ì„¤ìŠ¹ì¸" },
            { month: 3, process: "ì² íƒ‘(60m) ì¸ì–‘", risk: "í¬ë ˆì¸ ì „ë„, ë‚™í•˜", activity: "â€¢ [í‰ê°€] ì² íƒ‘ ì¸ì–‘ ìˆ˜ì‹œ ìœ„í—˜ì„±í‰ê°€\nâ€¢ [ë¶„ì„] 1ë¶„ê¸° ì•ˆì „ê´€ë¦¬ë¹„ ì‚¬ìš©ë‚´ì—­ ë¶„ì„\nâ€¢ [ì ê²€] í•©ë™ì ê²€: ì¤„ê±¸ì´ ë° ì§€ë°˜ìƒíƒœ", kpi: "ìœ„í—˜ìš”ì¸\nê°œì„ ìœ¨ 90%â†‘", docs: "ì¤‘ëŸ‰ë¬¼\nì‘ì—…ê³„íšì„œ" },
            { month: 4, process: "ì§€ìƒ ê³¨ì¡°, íƒ€ì„ì² ê³¨", risk: "ìš©ì ‘ í™”ì¬, ì¶”ë½", activity: "â€¢ [í™œë™] í™”ê¸°ì‘ì—… í—ˆê°€ì œ ë° ê°ì‹œì ë°°ì¹˜\nâ€¢ [TBM] ì² ê³¨ ìœ„ ì´ë™ ì‹œ ìƒëª…ì¤„ ì²´ê²°\nâ€¢ [í˜‘ì˜] í˜‘ë ¥ì—…ì²´ ì†Œì¥ë‹¨ ì•ˆì „ë³´ê±´í˜‘ì˜ì²´", kpi: "í™”ê¸°ì‘ì—…\nìŠ¹ì¸ 100%", docs: "í™”ê¸°ì‘ì—…\ní—ˆê°€ì„œ" },
            { month: 5, process: "ì˜¥ìƒ ê³¨ì¡°, ë°í¬", risk: "ë‹¨ë¶€ ì¶”ë½, ë¶•ê´´", activity: "â€¢ [êµìœ¡] ë°í¬í”Œë ˆì´íŠ¸ íŠ¹ë³„ì•ˆì „êµìœ¡\nâ€¢ [ì ê²€] í•©ë™ì ê²€: ë°í¬ ìš©ì ‘ë¶€ í™•ì¸\nâ€¢ [TBM] ìŠ¬ë˜ë¸Œ ë‹¨ë¶€ ì•ˆì „ë‚œê°„ ìƒíƒœ í™•ì¸", kpi: "TBM\nì°¸ì—¬ìœ¨ 100%", docs: "ë¹„ê³„ì¡°ë¦½\nìŠ¹ì¸ì„œ" },
            { month: 6, process: "ì¡°ì /ë°©ìˆ˜/ì°½í˜¸", risk: "ì¤‘ë…, ë§ë¹„ê³„ ì „ë„", activity: "â€¢ [ê²€í† ] ìƒë°˜ê¸° ì•ˆì „ë³´ê±´ ì´í–‰ê²°ê³¼ ê²½ì˜ê²€í† \nâ€¢ [í™œë™] ë°€íê³µê°„ ì§ˆì‹ì¬í•´ ì˜ˆë°© í”„ë¡œê·¸ë¨\nâ€¢ [ì ê²€] ìš°ê¸° ëŒ€ë¹„ íŠ¹ë³„ í•©ë™ì ê²€", kpi: "ë¶€ì í•© ì‚¬í•­\nì¡°ì¹˜ìœ¨ 100%", docs: "MSDS\nêµìœ¡ì¼ì§€" },
            { month: 7, process: "ì™¸ë²½/ë¹„ê³„ í•´ì²´", risk: "í•´ì²´ ì¤‘ ì¶”ë½/ë‚™í•˜", activity: "â€¢ [í‰ê°€] ë¹„ê³„ í•´ì²´ì‘ì—… ìˆ˜ì‹œ ìœ„í—˜ì„±í‰ê°€\nâ€¢ [êµìœ¡] í•´ì²´ ì‘ì—…ì íŠ¹ë³„ì•ˆì „êµìœ¡\nâ€¢ [ì ê²€] í•©ë™ì ê²€: í•˜ë¶€ í†µì œêµ¬ì—­ ì„¤ì •", kpi: "ì•„ì°¨ì‚¬ê³ \në°œêµ´ 5ê±´â†‘", docs: "í•´ì²´\nê³„íšì„œ" },
            { month: 8, process: "ë‚´ë¶€ ìˆ˜ì¥/ì²œì¥", risk: "ì‚¬ë‹¤ë¦¬ ì¶”ë½, í™”ì¬", activity: "â€¢ [êµìœ¡] í™”ì¬ ì˜ˆë°© ë° ë¹„ìƒ ëŒ€í”¼ í›ˆë ¨\nâ€¢ [TBM] ì´ë™ì‹ ì‚¬ë‹¤ë¦¬ ì „ë„ë°©ì§€ ì¡°ì¹˜\nâ€¢ [ì ê²€] í•©ë™ì ê²€: ê°€ì„¤ì „ê¸° ëˆ„ì „ í™•ì¸", kpi: "ë¹„ìƒí›ˆë ¨\nì‹¤ì‹œ ì™„ë£Œ", docs: "ê°€ì„¤ì „ê¸°\nì ê²€í‘œ" },
            { month: 9, process: "í† ëª©, ì„¤ë¹„(ì˜¤í† í‹°ì—…)", risk: "ì¥ë¹„ ì¶©ëŒ, í˜‘ì°©", activity: "â€¢ [ë¶„ì„] 3ë¶„ê¸° í•©ë™ì•ˆì „ì ê²€ ê²°ê³¼ ë¶„ì„\nâ€¢ [í™œë™] ì˜¤í† í‹°ì—… ì„¤ë¹„ LOTO ì¤€ìˆ˜\nâ€¢ [ì ê²€] í•©ë™ì ê²€: ì¥ë¹„ ìœ ë„ì› ë°°ì¹˜", kpi: "ì¥ë¹„ì ê²€\nì‹¤ì‹œìœ¨ 100%", docs: "ê¸°ê³„ê¸°êµ¬\në°©í˜¸ì¡°ì¹˜" },
            { month: 10, process: "ì¤€ê³µ ì²­ì†Œ, ì¸ê³„", risk: "ì „ë„, íê¸°ë¬¼ ì‚¬ê³ ", activity: "â€¢ [ê²€í† ] ê³µì‚¬ ì „ì²´ ë¬´ì¬í•´ ë‹¬ì„± ìµœì¢… í™•ì¸\nâ€¢ [í‰ê°€] ì¤€ê³µ ë§ˆë¬´ë¦¬ ì‘ì—… ìœ„í—˜ì„±í‰ê°€\nâ€¢ [ì •ë¦¬] ì•ˆì „ì‹œì„¤ë¬¼ ì² ê±° ì‹œ ê´€ë¦¬ì ì…íšŒ", kpi: "ë¬´ì¬í•´\në‹¬ì„±", docs: "ì•ˆì „ë³´ê±´\nëŒ€ì¥" }
        ];

        const defaultHeaderInfo = {
            period: "ì‹¤ì°©ê³µì¼ë¡œë¶€í„° 10ê°œì›” (2025.01 ~ 2025.10)",
            scale: "ì§€í•˜1ì¸µ ~ ì§€ìƒ4ì¸µ / 49íƒ€ì„ (ì² ê³¨+RCì¡°)",
            goal: "ì¤‘ëŒ€ì¬í•´ ZERO / ë¬´ì¬í•´ 300ì¼ ë‹¬ì„±"
        };

        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ë°ì´í„° ë¡œë“œ
        let allComments = JSON.parse(localStorage.getItem('namhwaComments')) || {};
        let allDetails = JSON.parse(localStorage.getItem('namhwaDetails')) || {};
        let safetyData = JSON.parse(localStorage.getItem('namhwaSafetyData')) || defaultSafetyRows;
        let kpiData = JSON.parse(localStorage.getItem('namhwaKpiData')) || defaultKpiData;
        let headerData = JSON.parse(localStorage.getItem('namhwaHeaderInfo')) || defaultHeaderInfo;

        // --- ë Œë”ë§ í•¨ìˆ˜ë“¤ ---
        
        function renderHeader() {
            document.getElementById('infoPeriod').innerText = headerData.period;
            document.getElementById('infoScale').innerText = headerData.scale;
            document.getElementById('infoGoal').innerText = headerData.goal;
        }

        function saveHeaderInfo() {
            const period = document.getElementById('infoPeriod').innerText;
            const scale = document.getElementById('infoScale').innerText;
            const goal = document.getElementById('infoGoal').innerText;
            headerData = { period, scale, goal };
            localStorage.setItem('namhwaHeaderInfo', JSON.stringify(headerData));
        }

        function renderGrid() {
            const grid = document.getElementById('mainGrid');
            grid.innerHTML = "";
            grid.innerHTML += `<div class="cell-header">êµ¬ë¶„ / ì›”</div>`;
            for(let i=1; i<=10; i++) grid.innerHTML += `<div class="cell-header">${i}ì›”</div>`;
            constructionData.forEach((task, index) => {
                let rowHTML = `<div class="cell cell-sidebar">${task.name}</div>`;
                for(let i=1; i<=10; i++) {
                    if(i === task.start) {
                        rowHTML += `<div class="cell" style="grid-column: span ${task.duration}; background:#fff; padding:5px;"><div class="task-bar ${task.color}" onclick="openModal(${index})">${task.label}</div></div>`;
                        i += (task.duration - 1);
                    } else { rowHTML += `<div class="cell"></div>`; }
                }
                grid.innerHTML += rowHTML;
            });
            grid.innerHTML += `<div class="divider-row">â–¼ ë²•ì  ì•ˆì „ê´€ë¦¬ ë° ì„±ê³¼ ì¸¡ì • ì¼ì • (í´ë¦­í•˜ì—¬ ìˆ˜ì •)</div>`;
            safetyData.forEach((row, rowIndex) => {
                let rowHTML = `<div class="cell cell-sidebar safety-row">${row.title}</div>`;
                for(let i=1; i<=10; i++) {
                    let tagsHTML = "";
                    if(row.monthlyTags[i]) {
                        row.monthlyTags[i].forEach(tagStr => {
                            const [text, color] = tagStr.split("|");
                            tagsHTML += `<div class="tag ${color}">${text}</div>`;
                        });
                    }
                    rowHTML += `<div class="cell tag-container clickable-cell" onclick="openSafetyModal(${rowIndex}, ${i})">${tagsHTML}</div>`;
                }
                grid.innerHTML += rowHTML;
            });
        }

        function renderKpiTable() {
            const tbody = document.getElementById('kpiTableBody');
            tbody.innerHTML = "";
            kpiData.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="kpi-td center"><strong>${row.month}ì›”</strong></td>
                    <td class="kpi-td editable center" contenteditable="true" onblur="updateKpiData(${index}, 'process', this.innerText)">${row.process}</td>
                    <td class="kpi-td editable center text-red" contenteditable="true" onblur="updateKpiData(${index}, 'risk', this.innerText)">${row.risk}</td>
                    <td class="kpi-td editable" contenteditable="true" style="white-space: pre-wrap;" onblur="updateKpiData(${index}, 'activity', this.innerText)">${row.activity}</td>
                    <td class="kpi-td editable center text-blue" contenteditable="true" style="white-space: pre-wrap;" onblur="updateKpiData(${index}, 'kpi', this.innerText)">${row.kpi}</td>
                    <td class="kpi-td editable center" contenteditable="true" style="white-space: pre-wrap;" onblur="updateKpiData(${index}, 'docs', this.innerText)">${row.docs}</td>
                `;
                tbody.appendChild(tr);
            });
        }
        function updateKpiData(index, key, value) {
            kpiData[index][key] = value;
            localStorage.setItem('namhwaKpiData', JSON.stringify(kpiData));
        }

        renderHeader();
        renderGrid();
        renderKpiTable();

        // --- íŒì—… ë¡œì§ ---
        let currentTaskIndex = null;
        let tempImageBase64 = null;
        const modal = document.getElementById('modal');
        const previewBox = document.getElementById('previewBox');
        const previewImg = document.getElementById('previewImg');
        const fileInput = document.getElementById('fileInput');

        function openModal(index) {
            currentTaskIndex = index;
            const defaultData = constructionData[index];
            const savedDetail = allDetails[index] || {};
            document.getElementById('modalTitle').innerText = defaultData.label + " ìƒì„¸ í™œë™";
            document.getElementById('modalRisk').value = savedDetail.risk !== undefined ? savedDetail.risk : (defaultData.risk || "");
            document.getElementById('modalKPI').value = savedDetail.kpi !== undefined ? savedDetail.kpi : (defaultData.kpi || "");
            document.getElementById('modalActivity').value = savedDetail.activity || "";
            fileInput.value = "";
            tempImageBase64 = savedDetail.imageData || null;
            if (tempImageBase64) {
                previewImg.src = tempImageBase64;
                previewBox.style.display = "block";
            } else {
                previewBox.style.display = "none";
                previewImg.src = "";
            }
            // ëŒ“ê¸€ ë Œë”ë§
            const list = document.getElementById('commentList');
            list.innerHTML = "";
            if (allComments[index]) allComments[index].forEach((c, i) => renderComment(c.name, c.content, c.date, i));
            modal.style.display = 'flex';
        }
        function closeModal() { modal.style.display = 'none'; }
        
        function handleFileSelect(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    tempImageBase64 = e.target.result;
                    previewImg.src = tempImageBase64;
                    previewBox.style.display = "block";
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        function deleteImage() {
            if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                tempImageBase64 = null;
                previewBox.style.display = "none";
                fileInput.value = "";
            }
        }
        function saveTaskDetails() {
            try {
                allDetails[currentTaskIndex] = {
                    risk: document.getElementById('modalRisk').value,
                    kpi: document.getElementById('modalKPI').value,
                    activity: document.getElementById('modalActivity').value,
                    imageData: tempImageBase64
                };
                localStorage.setItem('namhwaDetails', JSON.stringify(allDetails));
                alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            } catch (e) { alert("ì €ì¥ ì‹¤íŒ¨: ì´ë¯¸ì§€ ìš©ëŸ‰ ì´ˆê³¼"); }
        }

        // --- ëŒ“ê¸€ ê¸°ëŠ¥ (ì‚­ì œ í¬í•¨) ---
        function addComment() {
            const name = document.getElementById('writerName').value.trim();
            const content = document.getElementById('commentContent').value.trim();
            if(!name || !content) { alert("ì…ë ¥í•˜ì„¸ìš”."); return; }
            const dateStr = new Date().toISOString().slice(0,10);
            
            if (!allComments[currentTaskIndex]) allComments[currentTaskIndex] = [];
            allComments[currentTaskIndex].push({ name, content, date: dateStr });
            localStorage.setItem('namhwaComments', JSON.stringify(allComments));
            
            // ë¦¬ìŠ¤íŠ¸ ê°±ì‹ 
            const list = document.getElementById('commentList');
            list.innerHTML = "";
            allComments[currentTaskIndex].forEach((c, i) => renderComment(c.name, c.content, c.date, i));
            
            document.getElementById('commentContent').value = '';
        }

        function renderComment(name, content, date, index) {
            const list = document.getElementById('commentList');
            const newLi = document.createElement('li');
            newLi.className = 'comment-item';
            newLi.innerHTML = `
                <div><strong>${name}:</strong> ${content} <span class="comment-date">(${date})</span></div>
                <button class="btn-del-comment" onclick="deleteComment(${index})">ì‚­ì œ</button>
            `;
            list.appendChild(newLi);
        }

        // ëŒ“ê¸€ ì‚­ì œ (ë¹„ë°€ë²ˆí˜¸ í™•ì¸)
        function deleteComment(commentIndex) {
            const password = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
            if (password === "1234") {
                allComments[currentTaskIndex].splice(commentIndex, 1);
                localStorage.setItem('namhwaComments', JSON.stringify(allComments));
                // ë¦¬ìŠ¤íŠ¸ ê°±ì‹ 
                const list = document.getElementById('commentList');
                list.innerHTML = "";
                allComments[currentTaskIndex].forEach((c, i) => renderComment(c.name, c.content, c.date, i));
                alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            } else {
                if (password !== null) alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
            }
        }

        // --- ì•ˆì „ì¼ì • í¸ì§‘ ---
        let safetyEditRow = null;
        let safetyEditMonth = null;
        let tempTags = [];
        const safetyModal = document.getElementById('safetyModal');
        function openSafetyModal(rowIdx, month) {
            safetyEditRow = rowIdx;
            safetyEditMonth = month;
            document.getElementById('safetyModalTitle').innerText = `${month}ì›” ì¼ì • ìˆ˜ì •`;
            tempTags = [];
            if (safetyData[rowIdx].monthlyTags && safetyData[rowIdx].monthlyTags[month]) {
                tempTags = [...safetyData[rowIdx].monthlyTags[month]];
            }
            renderTempTags();
            document.getElementById('newTagText').value = "";
            safetyModal.style.display = 'flex';
        }
        function closeSafetyModal() { safetyModal.style.display = 'none'; }
        function renderTempTags() {
            const container = document.getElementById('currentTagList');
            container.innerHTML = "";
            tempTags.forEach((tagStr, idx) => {
                const [text, color] = tagStr.split("|");
                const span = document.createElement('span');
                span.className = `tag-item tag ${color}`;
                span.innerHTML = `${text} <span class="del-btn" onclick="removeSafetyTag(${idx})">Ã—</span>`;
                container.appendChild(span);
            });
        }
        function addSafetyTag() {
            const text = document.getElementById('newTagText').value.trim();
            const color = document.getElementById('newTagColor').value;
            if(!text) return;
            tempTags.push(`${text}|${color}`);
            renderTempTags();
            document.getElementById('newTagText').value = "";
            document.getElementById('newTagText').focus();
        }
        window.removeSafetyTag = function(idx) {
            tempTags.splice(idx, 1);
            renderTempTags();
        }
        function saveSafetyChanges() {
            if (!safetyData[safetyEditRow].monthlyTags) safetyData[safetyEditRow].monthlyTags = {};
            safetyData[safetyEditRow].monthlyTags[safetyEditMonth] = tempTags;
            localStorage.setItem('namhwaSafetyData', JSON.stringify(safetyData));
            renderGrid();
            closeSafetyModal();
        }
    </script>
</body>
</html>