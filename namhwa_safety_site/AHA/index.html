<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>위험성 평가_테스트</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* 기본 스타일 */
        *, *::before, *::after {
            box-sizing: border-box;
        }
        body {
            font-family: 'Malgun Gothic', sans-serif;
            color: #333;
            background-color: #f0f2f5;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
            vertical-align: middle;
            font-size: 14px;
            word-break: keep-all;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .container {
            max-width: 1600px;
            margin: 20px auto;
            padding: 20px;
            background-color: white;
        }
        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 16px;
        }
        
        .approval-table-container {
            width: 33%;
            flex-shrink: 0;
        }
        .approval-table th, .approval-table td {
            padding: 4px;
            font-size: 12px;
        }
        .approval-table input[type="date"] {
            width: 100%;
            border: none;
            text-align: center;
            font-size: 12px;
        }
        .main-title {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .main-title select {
            width: auto;
            font-size: 14px;
            font-weight: normal;
            margin-right: 10px;
            padding: 2px 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        input, textarea, select {
            width: 100%;
        }
        input[list] {
            min-height: 50px;
        }
        /* 입력란 높이 통일 */
        td input, td textarea, td select {
            min-height: 50px;
            border: 1px solid #ccc;
            padding: 4px;
            border-radius: 4px;
        }
        /* 날짜, 숫자 입력은 예외 */
        td input[type="date"], td input[type="number"] {
            min-height: auto;
        }
        /* 상단 테이블은 예외 */
        .mb-8 td input {
            min-height: auto;
            border: 1px solid #ccc;
        }


        textarea {
            resize: vertical;
        }
        .overflow-x-auto::-webkit-scrollbar { height: 8px; }
        .overflow-x-auto::-webkit-scrollbar-track { background: #f1f1f1; }
        .overflow-x-auto::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        .overflow-x-auto::-webkit-scrollbar-thumb:hover { background: #555; }
        
        .action-button {
            background-color: #4CAF50;
            color: white;
            padding: 8px 16px;
            text-align: center;
            font-size: 14px;
            margin: 10px 0;
            cursor: pointer;
            border-radius: 4px;
            border: none;
        }

        /* 저장/초기화 버튼 색상 추가 */
        .bg-blue-500 { background-color: #3b82f6; }
        .hover\:bg-blue-600:hover { background-color: #2563eb; }
        .bg-red-500 { background-color: #ef4444; }
        .hover\:bg-red-600:hover { background-color: #dc2626; }
        
        /* [신규] 삭제 버튼 스타일 */
        .delete-btn {
            background-color: #ef4444;
            color: white;
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
        }
        .delete-btn:hover {
            background-color: #dc2626;
        }


        .print-btn-container {
            text-align: right;
            max-width: 1600px;
            margin: 20px auto 0;
            padding: 0 20px;
        }
        .image-preview-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            gap: 5px;
        }
        .image-preview {
            max-width: 100%;
            max-height: 80px;
            object-fit: contain;
            border: 1px solid #eee;
            border-radius: 4px;
            display: block;
        }
        .image-placeholder {
            width: 100%;
            height: 80px;
            background-color: #f9f9f9;
            border: 1px dashed #ccc;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #888;
            font-size: 12px;
        }

            /* 인쇄용 스타일 */
        @media print {
            @page {
                size: landscape;
                margin: 1cm;
            }
            body {
                background-color: #fff !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .no-print {
                display: none !important;
            }
            .container {
                width: 100% !important;
                max-width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
                border: none !important;
                box-shadow: none !important;
            }
            .overflow-x-auto {
                overflow: visible !important;
            }
            table {
                width: 100% !important;
                table-layout: fixed !important; /* 너비를 강제하기 위해 fixed 레이아웃 사용 */
                page-break-inside: auto;
            }
            th, td {
                /* width: auto !important; 와 min-width: unset !important; 제거 */
                font-size: 9pt;
                padding: 5px;
                word-wrap: break-word; /* 긴 텍스트 줄바꿈 */
            }
            thead {
                display: table-header-group;
            }
            tbody tr {
                page-break-inside: avoid;
            }
            .header-section {
                page-break-after: avoid;
            }
            h1, h2 {
                page-break-after: avoid;
            }
            th {
                background-color: #f2f2f2 !important;
            }
            .main-title {
                font-size: 20pt;
            }
            .image-preview {
                max-height: 70px;
                border: 1px solid #ccc !important;
            }
            /* 인쇄 시 입력란 스타일 */
            input, textarea, select {
                border: none !important;
                background-color: transparent !important;
                box-shadow: none !important;
                padding: 1px;
                font-size: 9pt;
                /* 인쇄 시 내용이 잘리지 않도록 높이 자동 조절 */
                height: auto; 
                min-height: auto;
            }
            textarea {
                resize: none;
                overflow: hidden; /* 스크롤바 숨김 */
            }

            /* --- [수정됨] Table 1 인쇄 너비 --- */
            /* 삭제 버튼이 no-print이므로 nth-child 인덱스 변경 없음 */
            #risk-table-1 th:nth-child(1), #risk-table-1 td:nth-child(1) { width: 4% !important; } /* NO */
            #risk-table-1 th:nth-child(2), #risk-table-1 td:nth-child(2) { width: 22% !important; } /* 위험요인 */
            #risk-table-1 th:nth-child(3), #risk-table-1 td:nth-child(3) { width: 10% !important; } /* 장소 */
            #risk-table-1 th:nth-child(4), #risk-table-1 td:nth-child(4) { width: 5% !important; }  /* 빈도 */
            #risk-table-1 th:nth-child(5), #risk-table-1 td:nth-child(5) { width: 5% !important; }  /* 강도 */
            #risk-table-1 th:nth-child(6), #risk-table-1 td:nth-child(6) { width: 5% !important; }  /* 등급 */
            #risk-table-1 th:nth-child(7), #risk-table-1 td:nth-child(7) { width: 25% !important; } /* 개선대책 */
            #risk-table-1 th:nth-child(8), #risk-table-1 td:nth-child(8) { width: 8% !important; }  /* 법적근거 */
            #risk-table-1 th:nth-child(9), #risk-table-1 td:nth-child(9) { width: 6% !important; }  /* 조치기한 */
            #risk-table-1 th:nth-child(10), #risk-table-1 td:nth-child(10) { width: 5% !important; } /* 담당자 */
            #risk-table-1 th:nth-child(11), #risk-table-1 td:nth-child(11) { width: 5% !important; } /* 조치일 */

            /* --- [수정됨] Table 2 인쇄 너비 --- */
            /* 삭제 버튼이 no-print이므로 nth-child 인덱스 변경 없음 */
            #risk-table-2 th:nth-child(1), #risk-table-2 td:nth-child(1) { width: 5% !important; }  /* NO */
            #risk-table-2 th:nth-child(2), #risk-table-2 td:nth-child(2) { width: 25% !important; } /* 위험요인 */
            #risk-table-2 th:nth-child(3), #risk-table-2 td:nth-child(3) { width: 25% !important; } /* 조치사항 */
            #risk-table-2 th:nth-child(4), #risk-table-2 td:nth-child(4) { width: 10% !important; } /* 조치일 */
            #risk-table-2 th:nth-child(5), #risk-table-2 td:nth-child(5) { width: 10% !important; } /* 조치상태 */
            #risk-table-2 th:nth-child(6), #risk-table-2 td:nth-child(6) { width: 12.5% !important; } /* 조치 전 사진 */
            #risk-table-2 th:nth-child(7), #risk-table-2 td:nth-child(7) { width: 12.5% !important; } /* 조치 후 사진 */
        }
    </style>
</head>
<body class="bg-gray-50">

    <div class="print-btn-container no-print">
        <!-- 저장/초기화 버튼 추가 -->
        <button onclick="saveData()" class="action-button bg-blue-500 hover:bg-blue-600">내용 저장</button>
        <button onclick="clearData()" class="action-button bg-red-500 hover:bg-red-600">초기화</button>
        <button onclick="window.print()" class="action-button">인쇄</button>
    </div>

    <!-- =============== 평가표 작성 뷰 =============== -->
    <div id="assessment-view" class="container bg-white p-6 rounded-lg border-2 border-green-500 shadow-lg">
        <div class="header-section">
            <div>
                <div class="text-sm text-gray-600 no-print">
                    * 본 문서는 가로방향으로 출력해 주세요.
                </div>
                <div class="mt-4 flex items-center">
                    <label for="site-name" class="font-bold mr-2 whitespace-nowrap text-lg">현장명:</label>
                    <input type="text" id="site-name" value="" class="w-[400px] p-2 border border-gray-300 rounded-md text-lg">
                </div>
            </div>
            <div class="approval-table-container">
                <table class="approval-table">
                    <thead>
                        <tr>
                            <th>작성자</th>
                            <th>근로자대표</th>
                            <th>관리감독자</th>
                            <th>안전관리자</th>
                            <th>현장소장</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="h-16">
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td><input type="date" value="" class="text-center approval-date"></td>
                            <td><input type="date" value="" class="text-center approval-date"></td>
                            <td><input type="date" value="" class="text-center approval-date"></td>
                            <td><input type="date" value="" class="text-center approval-date"></td>
                            <td><input type="date" value="" class="text-center approval-date"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <h1 class="main-title">
             <select>
                <option>최초</option>
                <option>상시</option>
                <option>정기</option>
                <option>수시</option>
            </select>
            위험성 평가
        </h1>

        <div class="overflow-x-auto">
            <!-- [수정됨] 테이블에 ID 추가 -->
            <table id="risk-table-1" class="mb-8">
                <tbody>
                    <tr>
                        <th class="w-32">작업명</th>
                        <td colspan="3">
                            <input type="text" id="main-work-title-input" list="work-titles-list" oninput="populateAllRisksAndMeasures(this.value)" value="" class="p-1 border-gray-300 rounded-md">
                        </td>
                        <th class="w-32">작업기간</th>
                        <td colspan="2"><input type="text" value="" id="work-period" class="p-1 border-gray-300 rounded-md"></td>
                    </tr>
                    <tr>
                        <th>작성일</th>
                        <td colspan="3"><input type="text" value="" id="creation-date" class="p-1 border-gray-300 rounded-md"></td>
                        <th>소속</th>
                        <td colspan="2"><input type="text" value="" id="department" class="p-1 border-gray-300 rounded-md"></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="overflow-x-auto">
            <!-- [수정됨] 테이블에 ID 추가 -->
            <table id="risk-table-1" class="mb-2">
                <thead>
                    <tr>
                        <th class="w-12">NO</th>
                        <th>위험요인</th>
                        <th class="w-32">장소</th>
                        <th class="w-12">빈도</th>
                        <th class="w-12">강도</th>
                        <th class="w-12">등급</th>
                        <th>개선대책</th>
                        <th>법적근거</th>
                        <th class="w-24">조치기한</th>
                        <th class="w-20">담당자</th>
                        <th class="w-24">조치일</th>
                        <th class="w-16 no-print">삭제</th> <!-- [신규] 삭제 버튼 헤더 -->
                    </tr>
                </thead>
                <!-- 초기 행을 비워둠. 스크립트가 첫 행을 동적으로 추가함 -->
                <tbody id="table1-body"></tbody>
            </table>
        </div>
        <button onclick="addRow()" class="action-button mb-8 no-print">항목 추가</button>

        <h2 class="main-title">
            위험성 평가 이행 현황
        </h2>

        <div class="overflow-x-auto">
             <!-- [수정됨] 테이블에 ID 추가 -->
            <table id="risk-table-2" class="mb-2">
                <thead>
                    <tr>
                        <th class="w-12">NO</th>
                        <th>위험요인</th>
                        <th>조치사항</th>
                        <th class="w-32">조치일</th>
                        <th class="w-32">조치상태</th>
                        <th class="w-48">조치 전 사진</th>
                        <th class="w-48">조치 후 사진</th>
                        <th class="w-16 no-print">삭제</th> <!-- [신규] 삭제 버튼 헤더 -->
                    </tr>
                </thead>
                 <!-- 초기 행을 비워둠. 스크립트가 첫 행을 동적으로 추가함 -->
                <tbody id="table2-body"></tbody>
            </table>
        </div>
    </div>

    <!-- 미리 정의된 데이터 목록 (datalist) -->
    <datalist id="work-titles-list"></datalist>

    <datalist id="persons-list">
        <option value="홍길동"></option>
        <option value="김철수"></option>
        <option value="이영희"></option>
        <option value="박안전"></option>
    </datalist>

    <datalist id="status-list">
        <option value="조치 완료"></option>
        <option value="진행 중"></option>
        <option value="계획 중"></option>
        <option value="해당 없음"></option>
    </datalist>
    
    <script>
        // --------------------------------------------------
        // [데이터 수정] 여기에서 '작업명' 목록을 수정하세요.
        // --------------------------------------------------
        window.workData = [
          {
            "workName": "가설분전함 설치/자재반입 및 준비작업",
            "risks": [
              { "risk": "작업방법 및 내용 미확인으로 인한 안전사고 발생", "measure": "작업계획,내용에 따른 위험성을 평가하고 TBM 실시" },
              { "risk": "운반트럭 적재함에 근로자 임의로 올라가서 작업중 추락", "measure": "적재함 탑승 및 작업금지" },
              { "risk": "운반차량 적재함에 승/하강 중 뛰어내리는 등 불안전한 행동", "measure": "적재함 탑승 금지" },
              { "risk": "지게차 운전원 운전미숙을 작업중 근로자와 충돌", "measure": "사전 지게차 운전원 자격유무 확인, 교육실시" },

            ]
          },
          {
            "workName": "외부 비계 설치",
            "risks": [
              { "risk": "비계 조립 중 추락 위험", "measure": "안전대 착용, 작업발판 설치" },
              { "risk": "자재 낙하 위험", "measure": "낙하물 방지망 설치, 하부 통제" },
              { "risk": "강풍 시 비계 전도 위험", "measure": "벽이음쇠(Tie) 설치 확인" }
            ]
          },
          {
            "workName": "터파기 작업",
            "risks": [
              { "risk": "굴착면 붕괴 위험", "measure": "흙막이 지보공 설치, 경사면 확보" }
            ]
          }
        ];
        // --------------------------------------------------

        // 작업명과 위험요인 배열을 연결하는 데이터
        let workDataMap = {};
        // 전체 행 카운터
        let rowCount = 0;
        
        // --- [신규] 행 번호 재정렬 함수 ---
        window.renumberRows = () => {
            const tableBody1 = document.getElementById('table1-body');
            const tableBody2 = document.getElementById('table2-body');
            
            const rows1 = tableBody1.querySelectorAll('tr');
            const rows2 = tableBody2.querySelectorAll('tr');

            const currentRowCount = rows1.length; // 두 테이블의 행 수는 같아야 함

            for (let i = 0; i < currentRowCount; i++) {
                const newRowNumber = i + 1;
                
                // Table 1의 NO 업데이트
                if (rows1[i]) {
                    const firstCell1 = rows1[i].querySelector('td:first-child');
                    if (firstCell1) firstCell1.textContent = newRowNumber;
                }

                // Table 2의 NO 업데이트
                if (rows2[i]) {
                    const firstCell2 = rows2[i].querySelector('td:first-child');
                    if (firstCell2) firstCell2.textContent = newRowNumber;
                }
            }
            
            // [중요] 전역 rowCount 변수도 업데이트
            window.rowCount = currentRowCount;
        }
        
        // --- [신규] 행 삭제 함수 ---
        window.deleteRow = (buttonEl) => {
            // 1. 확인창 띄우기
            if (!window.confirm("이 항목을 정말로 삭제하시겠습니까?")) {
                return;
            }

            // 2. 현재 행(tr) 찾기
            const rowToRemove = buttonEl.closest('tr');
            if (!rowToRemove) return;

            // 3. 현재 테이블(tbody)과 다른 테이블(tbody) 찾기
            const currentTbody = rowToRemove.closest('tbody');
            const otherTbody = (currentTbody.id === 'table1-body') ? document.getElementById('table2-body') : document.getElementById('table1-body');
            
            // 4. 현재 행의 인덱스(순번) 찾기
            const rowIndex = Array.from(currentTbody.children).indexOf(rowToRemove);

            // 5. 다른 테이블에서 동일한 인덱스의 행 찾기
            const otherRowToRemove = otherTbody.rows[rowIndex];

            // 6. 양쪽 테이블에서 행 삭제
            if (rowToRemove) {
                rowToRemove.remove();
            }
            if (otherRowToRemove) {
                otherRowToRemove.remove();
            }

            // 7. 삭제 후 전체 행 번호 재정렬
            renumberRows();
        }


        window.addRow = (risk = '', measure = '') => {
            rowCount++;
            const rowNum = rowCount;

            const tableBody1 = document.getElementById('table1-body');
            const newRow1 = tableBody1.insertRow();
            newRow1.innerHTML = `
                <td>${rowNum}</td>
                <td><textarea class="p-1 border border-gray-300 rounded-md risk-input">${risk}</textarea></td>
                <td><input type="text" value="" class="p-1 border border-gray-300 rounded-md"></td>
                <td><input type="number" value="" class="p-1 border border-gray-300 rounded-md text-center"></td>
                <td><input type="number" value="" class="p-1 border border-gray-300 rounded-md text-center"></td>
                <td><input type="number" value="" class="p-1 border border-gray-300 rounded-md text-center"></td>
                <td><textarea class="p-1 border border-gray-300 rounded-md measure-input">${measure}</textarea></td>
                <td><input type="text" value="" class="p-1 border border-gray-300 rounded-md"></td>
                <td><input type="date" value="" class="p-1 border border-gray-300 rounded-md"></td>
                <td><input type="text" value="" list="persons-list" class="p-1 border border-gray-300 rounded-md"></td>
                <td><input type="date" value="" class="p-1 border border-gray-300 rounded-md"></td>
                <td class="no-print"><button type="button" onclick="deleteRow(this)" class="delete-btn">삭제</button></td>
            `;

            const tableBody2 = document.getElementById('table2-body');
            const newRow2 = tableBody2.insertRow();
            newRow2.innerHTML = `
                <td>${rowNum}</td>
                <td><textarea class="p-1 border border-gray-300 rounded-md risk-input">${risk}</textarea></td>
                <td><textarea class="p-1 border border-gray-300 rounded-md measure-input">${measure}</textarea></td>
                <td><input type="date" value="" class="p-1 border border-gray-300 rounded-md"></td>
                <td><input type="text" value="" list="status-list" class="p-1 border border-gray-300 rounded-md"></td>
                <td>
                    <div class="image-preview-container">
                        <img src="" alt="조치 전 사진" class="image-preview" id="preview-before-${rowNum}" style="display:none;">
                        <div class="image-placeholder" id="placeholder-before-${rowNum}" style="display:flex;">사진 없음</div>
                        <input type="file" accept="image/*" capture="environment" class="text-xs no-print" onchange="previewImage(event, 'preview-before-${rowNum}', 'placeholder-before-${rowNum}')">
                    </div>
                </td>
                <td>
                    <div class="image-preview-container">
                        <img src="" alt="조치 후 사진" class="image-preview" id="preview-after-${rowNum}" style="display:none;">
                        <div class="image-placeholder" id="placeholder-after-${rowNum}" style="display:flex;">사진 없음</div>
                        <input type="file" accept="image/*" capture="environment" class="text-xs no-print" onchange="previewImage(event, 'preview-after-${rowNum}', 'placeholder-after-${rowNum}')">
                    </div>
                </td>
                <td class="no-print"><button type="button" onclick="deleteRow(this)" class="delete-btn">삭제</button></td>
            `;
        };
        
        // --- 저장된 데이터를 불러와 행을 생성하는 새 함수 ---
        window.loadRow = (rowNum, row1Data, row2Data) => {
            rowCount = rowNum; // 행 번호 동기화

            const tableBody1 = document.getElementById('table1-body');
            const newRow1 = tableBody1.insertRow();
            newRow1.innerHTML = `
                <td>${rowNum}</td>
                <td><textarea class="p-1 border border-gray-300 rounded-md risk-input">${row1Data.risk}</textarea></td>
                <td><input type="text" value="${row1Data.location}" class="p-1 border border-gray-300 rounded-md"></td>
                <td><input type="number" value="${row1Data.freq}" class="p-1 border border-gray-300 rounded-md text-center"></td>
                <td><input type="number" value="${row1Data.strength}" class="p-1 border border-gray-300 rounded-md text-center"></td>
                <td><input type="number" value="${row1Data.grade}" class="p-1 border border-gray-300 rounded-md text-center"></td>
                <td><textarea class="p-1 border border-gray-300 rounded-md measure-input">${row1Data.measure}</textarea></td>
                <td><input type="text" value="${row1Data.legal}" class="p-1 border border-gray-300 rounded-md"></td>
                <td><input type="date" value="${row1Data.deadline}" class="p-1 border border-gray-300 rounded-md"></td>
                <td><input type="text" value="${row1Data.manager}" list="persons-list" class="p-1 border border-gray-300 rounded-md"></td>
                <td><input type="date" value="${row1Data.actionDate}" class="p-1 border border-gray-300 rounded-md"></td>
                <td class="no-print"><button type="button" onclick="deleteRow(this)" class="delete-btn">삭제</button></td>
            `;

            const tableBody2 = document.getElementById('table2-body');
            const newRow2 = tableBody2.insertRow();
            
            // 이미지 src 및 플레이스홀더 표시 여부 결정
            const imgBeforeSrc = row2Data.imgBefore || "";
            const imgAfterSrc = row2Data.imgAfter || "";
            const imgBeforeDisplay = imgBeforeSrc ? 'block' : 'none';
            const placeholderBeforeDisplay = imgBeforeSrc ? 'none' : 'flex';
            const imgAfterDisplay = imgAfterSrc ? 'block' : 'none';
            const placeholderAfterDisplay = imgAfterSrc ? 'none' : 'flex';
            
            newRow2.innerHTML = `
                <td>${rowNum}</td>
                <td><textarea class="p-1 border border-gray-300 rounded-md risk-input">${row2Data.risk}</textarea></td>
                <td><textarea class="p-1 border border-gray-300 rounded-md measure-input">${row2Data.measure}</textarea></td>
                <td><input type="date" value="${row2Data.actionDate}" class="p-1 border border-gray-300 rounded-md"></td>
                <td><input type="text" value="${row2Data.status}" list="status-list" class="p-1 border border-gray-300 rounded-md"></td>
                <td>
                    <div class="image-preview-container">
                        <img src="${imgBeforeSrc}" alt="조치 전 사진" class="image-preview" id="preview-before-${rowNum}" style="display:${imgBeforeDisplay};">
                        <div class="image-placeholder" id="placeholder-before-${rowNum}" style="display:${placeholderBeforeDisplay};">사진 없음</div>
                        <input type="file" accept="image/*" capture="environment" class="text-xs no-print" onchange="previewImage(event, 'preview-before-${rowNum}', 'placeholder-before-${rowNum}')">
                    </div>
                </td>
                <td>
                    <div class="image-preview-container">
                        <img src="${imgAfterSrc}" alt="조치 후 사진" class="image-preview" id="preview-after-${rowNum}" style="display:${imgAfterDisplay};">
                        <div class="image-placeholder" id="placeholder-after-${rowNum}" style="display:${placeholderAfterDisplay};">사진 없음</div>
                        <input type="file" accept="image/*" capture="environment" class="text-xs no-print" onchange="previewImage(event, 'preview-after-${rowNum}', 'placeholder-after-${rowNum}')">
                    </div>
                </td>
                <td class="no-print"><button type="button" onclick="deleteRow(this)" class="delete-btn">삭제</button></td>
            `;
        };


        // 작업명 선택 시 모든 표의 위험요인과 개선대책을 자동으로 채우는 함수
        window.populateAllRisksAndMeasures = (selectedWork) => {
            const risksArray = workDataMap[selectedWork];
            if (!risksArray) {
                // 맵에 없는 작업명(사용자 직접 입력 등)이면 기존 내용만 지움
                const tableBody1 = document.getElementById('table1-body');
                const tableBody2 = document.getElementById('table2-body');
                tableBody1.innerHTML = '';
                tableBody2.innerHTML = '';
                rowCount = 0;
                addRow(); // 빈 행 1개 추가
                return;
            }
            
            // [수정] 덮어쓰기 방지 확인 로직
            const tableBody1 = document.getElementById('table1-body');
            const tableBody2 = document.getElementById('table2-body');
            const isTableEmpty = tableBody1.rows.length === 0 || 
                                (tableBody1.rows.length === 1 && 
                                 tableBody1.rows[0].querySelector('textarea.risk-input').value === '' &&
                                 tableBody1.rows[0].querySelector('textarea.measure-input').value === '');

            if (!isTableEmpty && !window.confirm("작업명을 변경하면 현재 작성된 내용이 기본값으로 덮어씌워집니다.\n계속하시겠습니까?")) {
                // "취소" 누르면, 작업명 입력을 이전에 저장된 값으로 되돌림
                try {
                    const savedData = localStorage.getItem(SAVE_KEY);
                    if(savedData) {
                        document.getElementById('main-work-title-input').value = JSON.parse(savedData).mainWorkTitle || '';
                    } else {
                        document.getElementById('main-work-title-input').value = '';
                    }
                } catch(e) {
                    document.getElementById('main-work-title-input').value = '';
                }
                return;
            }


            // 1. 기존 테이블 내용 삭제
            tableBody1.innerHTML = '';
            tableBody2.innerHTML = '';
            
            // 2. rowCount 초기화
            rowCount = 0; 

            // 3. riskArray를 순회하며 새 행 추가
            risksArray.forEach(item => {
                addRow(item.risk, item.measure); 
            });

            // 4. 만약 risksArray가 비어있다면, 최소 1개의 빈 행을 추가
            if (risksArray.length === 0) {
                addRow();
            }
        };

        window.previewImage = (event, previewId, placeholderId) => {
            const reader = new FileReader();
            reader.onload = function(){
                const output = document.getElementById(previewId);
                const placeholder = document.getElementById(placeholderId);
                output.src = reader.result;
                output.style.display = 'block';
                if (placeholder) {
                    placeholder.style.display = 'none';
                }
            };
            if (event.target.files[0]) {
                reader.readAsDataURL(event.target.files[0]);
            } else {
                const output = document.getElementById(previewId);
                const placeholder = document.getElementById(placeholderId);
                output.src = "";
                output.style.display = 'none';
                if (placeholder) {
                    placeholder.style.display = 'flex';
                }
            }
        };

        // --- localStorage 관련 새 함수 ---

        const SAVE_KEY = 'riskAssessmentData';

        // [신규] 1. 데이터 저장 함수
        window.saveData = () => {
            try {
                const dataToSave = {
                    siteName: document.getElementById('site-name').value,
                    approvalDates: [],
                    mainWorkTitle: document.getElementById('main-work-title-input').value,
                    workPeriod: document.getElementById('work-period').value,
                    creationDate: document.getElementById('creation-date').value,
                    department: document.getElementById('department').value,
                    table1Rows: [],
                    table2Rows: []
                };

                // 결재일 저장
                document.querySelectorAll('.approval-date').forEach(input => {
                    dataToSave.approvalDates.push(input.value);
                });

                // 테이블 1 데이터 저장
                document.querySelectorAll('#table1-body tr').forEach(row => {
                    const inputs = row.querySelectorAll('input, textarea');
                    dataToSave.table1Rows.push({
                        risk: inputs[0].value,
                        location: inputs[1].value,
                        freq: inputs[2].value,
                        strength: inputs[3].value,
                        grade: inputs[4].value,
                        measure: inputs[5].value,
                        legal: inputs[6].value,
                        deadline: inputs[7].value,
                        manager: inputs[8].value,
                        actionDate: inputs[9].value,
                    });
                });

                // 테이블 2 데이터 저장 (이미지 src 포함)
                document.querySelectorAll('#table2-body tr').forEach(row => {
                    const inputs = row.querySelectorAll('input, textarea');
                    const imgBefore = row.querySelector('.image-preview[id^="preview-before-"]').src;
                    const imgAfter = row.querySelector('.image-preview[id^="preview-after-"]').src;
                    
                    dataToSave.table2Rows.push({
                        risk: inputs[0].value,
                        measure: inputs[1].value,
                        actionDate: inputs[2].value,
                        status: inputs[3].value,
                        // http: 또는 file: 로 시작하는 기본 경로 이미지는 저장하지 않음 (data: URL만 저장)
                        imgBefore: imgBefore.startsWith('data:image') ? imgBefore : '',
                        imgAfter: imgAfter.startsWith('data:image') ? imgAfter : ''
                    });
                });

                localStorage.setItem(SAVE_KEY, JSON.stringify(dataToSave));
                alert('내용이 브라우저에 저장되었습니다.');

            } catch (error) {
                console.error("데이터 저장 중 오류 발생:", error);
                alert('데이터 저장 중 오류가 발생했습니다. 개발자 콘솔을 확인해주세요.');
            }
        };

        // [신규] 2. 데이터 불러오기 함수
        window.loadData = () => {
            const savedData = localStorage.getItem(SAVE_KEY);
            if (!savedData) {
                // 저장된 데이터가 없으면 빈 행 1개 추가
                addRow();
                return;
            }

            try {
                const data = JSON.parse(savedData);

                // 헤더 정보 복원
                document.getElementById('site-name').value = data.siteName || '';
                document.getElementById('main-work-title-input').value = data.mainWorkTitle || '';
                document.getElementById('work-period').value = data.workPeriod || '';
                document.getElementById('creation-date').value = data.creationDate || '';
                document.getElementById('department').value = data.department || '';

                // 결재일 복원
                const approvalDateInputs = document.querySelectorAll('.approval-date');
                if (data.approvalDates) {
                    data.approvalDates.forEach((date, index) => {
                        if (approvalDateInputs[index]) {
                            approvalDateInputs[index].value = date;
                        }
                    });
                }

                // 테이블 복원 (기존 행 삭제)
                document.getElementById('table1-body').innerHTML = '';
                document.getElementById('table2-body').innerHTML = '';
                rowCount = 0;

                // 저장된 행 개수에 맞춰 행 복원
                if (data.table1Rows && data.table2Rows && data.table1Rows.length === data.table2Rows.length && data.table1Rows.length > 0) {
                    for (let i = 0; i < data.table1Rows.length; i++) {
                        loadRow(i + 1, data.table1Rows[i], data.table2Rows[i]);
                    }
                } else {
                    // 데이터가 비어있거나 깨진 경우
                    addRow();
                }

            } catch (error) {
                console.error("데이터 불러오기 중 오류 발생:", error);
                alert('저장된 데이터를 불러오는 중 오류가 발생했습니다.');
                localStorage.removeItem(SAVE_KEY); // 손상된 데이터 삭제
                addRow(); // 빈 행 추가
            }
        };

        // [신규] 3. 데이터 초기화 함수
        window.clearData = () => {
            // confirm() 대신 간단한 알림 후 처리 (사용자 요청 사항)
            if (window.confirm("정말로 모든 내용을 초기화하시겠습니까?\n저장된 데이터가 영구히 삭제됩니다.")) {
                localStorage.removeItem(SAVE_KEY);
                location.reload();
            }
        };

        // *** [오류 수정] ***
        // DOMContentLoaded 리스너를 스크립트의 맨 마지막으로 이동시킵니다.
        // 모든 함수가 window 객체에 정의된 *후*에 이 리스너가 실행됩니다.
        document.addEventListener('DOMContentLoaded', () => {
            // 1. workData(위에서 정의)를 Datalist와 Map에 채웁니다.
            const workTitlesDatalist = document.getElementById('work-titles-list');
            if (workTitlesDatalist) {
                workTitlesDatalist.innerHTML = ''; // 목록 초기화
                
                window.workData.forEach(item => {
                    // 1. 자동 완성 JS 객체 채우기 (risks 배열 통째로 저장)
                    workDataMap[item.workName] = item.risks;
                    
                    // 2. 자동 완성 Datalist 채우기
                    const option = document.createElement('option');
                    option.value = item.workName;
                    workTitlesDatalist.appendChild(option);
                });
            } else {
                console.error("'work-titles-list' Datalist를 찾을 수 없습니다.");
            }
            
            // 2. 페이지 로드 시 저장된 데이터 불러오기
            // 이제 loadData()가 window 객체에 확실히 정의되어 있습니다.
            loadData();
        });
    </script>
</body>
</html>

